# 日历

## 目标
弄懂、搞懂 🗓️ ！

## 🗓️ 是什么？

### 一. 阳历

- 阳历 每月日期都为固定，把**闰年**问题解决即可
- 闰年又分 “普通闰年” 和 “世纪闰年”
  - 普通闰年：公历年份是4的倍数的，且不是100的倍数，为普通闰年（如2004年、2020年就是闰年）。
  - 世纪闰年：公历年份是整百数的，必须是400的倍数才是世纪闰年（如1900年不是世纪闰年，2000年是世纪闰年）。
#### 1.1 阳历计算日期
阳历计算就不多赘述了。除了考虑 闰年下的2月份是28天还是29外, 其余月份均一样。
```
// 计算 2月份 是28天 还是29天

(year % 4 === 0 && year % 100 !== 0) || year % 400 === 0) ? 29 : 28
```

### 二. 阴阳历（农历）
#### 2.1 阴阳历怎么来的？
- 农历是以华历（阴历）为基础，融合阳历成分而成的一种历法。所以我国的农历从严格意义上说不应该叫阴历，而是阴阳合历；[详看百度百科](https://baike.baidu.com/item/%E5%86%9C%E5%8E%86/67925)

- 所以平常我们说的阴历其实是**阴阳历或农历。** 那阴阳历是怎么来的？主要是天文台夜观天象得来的，并非向阳历那般有固定日期。现有农历数据只有1949年-2100年 200年的数据 

- 阴阳历数据源: [香港天文台](https://www.hko.gov.hk/tc/gts/time/conversion1_text.htm#)


#### 2.2 农历计算日期
##### 2.2.1 通用计算公式
**（输入的阳历日期 − 阳历基准 + 1）=（输出的农历日期 − 农历基准 + 1）= 相差天数**

- 先计算输入的阳历日期与阳历基准之间相差天数，**计算出的相差天数是固定的。** 

- 之后在根据 **相差天数反推出农历日期**

##### 2.2.2 确认阳历基准与农历基准
基准可以是日历上的任意一天，但是**阳历基准和农历基准必须是同一天。** 要注意的是设置基准后，**基准以前的日期将计算错误，只能计算基准以后的。**

基准年份要与农历年份数组第一个值相对应，要不然也会出现计算误差。

例：将[香港天文台](https://www.hko.gov.hk/tc/gts/time/conversion1_text.htm#)中每一年的数据转换成 16进制编码
```
const solarYear = 2019 // 阳历年份基准

const lunarYearArr = [
    0x0a930, //2019
    ......,
    0x0e968, 0x0d520, 0x0daa0, 0x16aa6, 0x056d0, 0x04ae0, 0x0a9d4, 0x0a2d0, 0x0d150, 0x0f252, //2090-2099
    0x0d520 //2100
] // 农历年份 数组，第一个必须为 2019; 也就是农历年份基准

```
##### 2.2.3 计算农历年份
- 使用 相差天数 **依次减去** 农历数组中每一年的天数 = 剩余相差天数

- 剩余相差天数 <= 0 时 **即确认当前农历年份**

##### 2.2.4 计算农历月份
- 确认农历年份后，最后一次减去的年份天数 + 剩余相差天数 = 当前年份的相差天数

- 使用 当前年份的相差天数 **依次减去** 当前年份中的每月的天数 = 剩余相差天数

- 剩余相差天数 <= 0 时 **即确认当前农历月份**

##### 2.2.5 计算农历日份
- 确认农历月份后，最后一次减去的月份天数 + 剩余相差天数 = **当前农历日份**

### 三. Q & A
#### <span id="year">3.1 如何使用 16进制编码的年份</span>
```
const lunarYearArr = [
    0x0b557, //1949
    0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5b0, 0x14573, 0x052b0, 0x0a9a8, 0x0e950, 0x06aa0, //1950-1959
    .....,
]
```
将 0x0b557 除 0x 外的 0b557(16进制) 转为 二进制，会得到以下数据：

0000 1011 0101 0101 0111

分别表示：

xxxx | xxxx | xxxx | xxxx | xxxx
---  | ---  | ---  | ---  | ---
20-17| 16-12| 12-9 | 8-5  |	4-1

1-4位： 表示是否为闰年，是 则为闰年的月份； 否 为 0；

5-16位： 除闰年外的正常月份，1为 30天大月；0为 29天小月；**(1月-12月的对应顺序为16位-5位)**

17-20位：表示闰月为 大月还是小月，有闰月时才有意义；**农历大月为30天 小月为29天**

例：
```
>> 无闰月版
2019年的 16进制为0x0a930 二进制为 1010100100110000

1010 1001 0011 0000; 可以看到 17-20位是没有的，因为2019年没有闰月

2019年全年月份1-12月
30,29,30,29,  30,29,29,30,  29,29,30,30


------
>> 有闰月-小月版
2020年的 16进制为0x07954 二进制为111100101010100 //这里的二进制只有15位, 手动添0，添置到16位

0111 1001 0101 0100; 1-4位 0100 转成 十进制为 4 所以是闰4月; 17-20位不存在则为小月29天

2020年全年月份 1-12月 + 闰4月 = 13月
1-12月: 29,30,30,30,        30,29,29,30  29,30,29,30
闰4月:                 29,
1-13月: 29,30,30,30,   29,  30,29,29,30  29,30,29,30


------
>> 有闰月-大月版
2036年的 16进制为0x1d0b6 二进制为11101000010110110 //这里的二进制只有17位，手动添0，添置到20位

0001 1101 0000 1011 0110; 1-4位 0110 转成 十进制为 6 所以是闰6月; 17-20位存在则为大月30天

2036年全年月份 1-12月 + 闰6月 = 13月
1-12月: 30,30,29,30, 29,29,       29,29  30,29,30,30
闰6月:                       30,
1-13月: 30,30,29,30, 29,29,  30,  29,29  30,29,30,30
```
#### 3.2 如何计算农历年份天数

请先看完[3.1 如何使用 16进制编码的年份](#year)后 再来！ 

知道每月天数后，依次相加 计算出每年的天数; 闰年天数也要加上哦！

#### <span id="diff">3.3 如何计算相差天数</span>
主要利用 [Date.UTC](https://www.w3school.com.cn/jsref/jsref_utc.asp)方法

这里以 JavaScript 为例:
```
const sy = 2020, // 阳历年
      sm = 11,   // 阳历月 0-11月
      sd = 9;    // 阳历日

// 相差天数 = 阳历日期 − 阳历基准 + 1; 
const day_diff = (Date.UTC(sy, sm, sd) - Date.UTC(1949, 0, 29)) / (24 * 60 * 60 * 1000) + 1
console.log(day_diff) // 26248

// 这里的 1949, 0, 29 为阳历基准

```
#### 3.4 由相差天数如何计算出农历日期
由[3.3 如何计算相差天数](#diff)得出 以2020年12月09日日期的相差天数为 26248

由[3.1 如何使用 16进制编码的年份](#year)计算出每年的天数
<!-- 出 2020 年的 总年天数 384 -->
##### 3.4.1 计算农历年
```
const day_diff = 26248   // 2020年12月09日 至 1949年01月29日的 相差天数
const BASIS = 1949 // 基准年 1949 年

const years = [
    384, // 1949
    354, 355, 384, 354, 355, 384, 354, 383, 355, 354, // 1950-1959
    ......, 
] // 将 16进制编码 转换 2进制  并计算出每年的总天数

let ly = 0  // 农历年

// 计算 农历年
for (let i = 0; years.length < i; i++) {
  day_diff -= years[i]

  if (day_diff <= 0) {
    ly = BASIS + i 
    day_diff += years[i] // 剩余相差天数 320天
    break;
  }
}
console.log(ly) // 2020年
```
##### 3.4.2 计算农历月、农历日
```
// 2020年 16进制 0x07954 转 2进制 111100101010100 

// 111100101010100 不足20位 在前面添置 0 补充位数至20位

// 1-4位  : 0100 = 4 = 闰 4 月
// 5-16位 : 0111 1001 0101 = 29,30,30,30,  30,29,29,30,  29,30,29,30
// 17-20位: 0000 = 0 = 小月

let months = [29,30,30,30,       30,29,29,30, 29,30,29,30] // 正常月份
    months = [29,30,30,30,  29,  30,29,29,30, 29,30,29,30] // 加上 闰4月的 天数


let lm = 0,  // 农历月
    ld = 0;  // 农历日

const day_diff = 320 //依次减去年份 剩余相差天数为 320天

// 计算农历月 与 农历日
for (let i = 0; months.length < i; i++){
  day_diff -= months[i]

  if (day_diff <= 0) { // 依次相减, 减到小于0为止, 减至小于0时 i = 12

    if (months.length === 13) { // 长度为 13 为有闰月
      let m = 4 // 由 1-4位知道是 闰4月

      if (m < i) lm = i // (4 < 12) lm = 12
      else if (m === i) lm = `闰${m}`
      else lm = i + 1

    } else {
      lm = i + 1
    }
    
    ld = day_diff += months[i] // 25
    break
  }
}
console.log(lm, ld) // 12月25日

```

### 四. 扩展
#### 4.1 天干地支
天干=（公历年份）/10，所得余数

地支=（公历年份）/12，所得余数

生肖与地支公式一样

天干 |甲 | 乙 | 丙 | 丁  | 戊  | 己  | 庚 | 辛  | 壬  | 癸
--- | ---| ---| ---| --- | --- | --- | ---| ---| --- | ---
余数 | 4  | 5  | 6  | 7   | 8   | 9   | 0  | 1  | 2   | 3


地支 |子 |丑 | 寅 | 卯 | 辰 | 巳 | 午 | 未 | 申 | 酉 | 戌 | 亥 
--- | ---| ---| ---| ---| ---| ---| ---| ---| --- | ---| ---| ---
余数   | 4  | 5  | 6  | 7  |  8 | 9  | 10 | 11 | 12  | 1  | 2  | 3 


生肖 |鼠 |牛 | 虎 | 兔 | 龙 | 蛇 | 马 | 羊 | 猴 | 鸡 | 狗 | 猪 
--- | ---| ---| ---| ---| ---| ---| ---| ---| --- | ---| ---| ---
余数   | 4  | 5  | 6  | 7  |  8 | 9  | 10 | 11 | 12  | 1  | 2  | 3 

#### 4.2 节日日期
##### 4.2.1 农历节日
```
{
  '1223': '北方小年',
  '1224': '南方小年',
  '1230': '除夕',
  '0101': '春节',
  '0115': '元宵',
  '0202': '龙抬头',
  '0505': '端午节',
  '0707': '七夕',
  '0815': '中秋节',
  '0909': '重阳节',
  '1013': '生日',
  '1208': '腊八'
}
```
##### 4.2.2 阳历节日
```
{
  '0101': '元旦',
  '0214': '情人节',
  '0308': '妇女节',
  '0312': '植树节',
  '0315': '消费者日',
  '0401': '愚人节',
  '0501': '劳动节',
  '0504': '青年节',
  '0512': '护士节',
  '0601': '儿童节',
  '0701': '建党日',
  '0801': '建军节',
  '0910': '教师节',
  '0918': '九一八',
  '1001': '国庆节',
  '1013': '生日',
  '1111': '光棍节',
  '1224': '平安夜',
  '1225': '圣诞节'
}
```

#### 4.3 节气
虽然已经实现节气了、但总感觉哪里不对劲、解惑后再来。

## 实现

- 示例地址：[Calendar](https://github.com/angxuejian/moto.wxui/tree/main/UI/calendar)

## 最后
能明白日历, 感觉还是很开心的。不过有些疑虑。

当各个平台将农历日期偷偷修改后、大众是无感知的、

## 参考文献
[1] [limengwe-关于日历实现代码里0x04bd8, 0x04ae0, 0x0a570的解释](https://blog.csdn.net/onlyonecoder/article/details/8484118)

[2] [xm2by-日历的公历转农历](https://blog.csdn.net/XuM222222/article/details/82012802)

[3] [xm2by-原生js实现公历转农历](https://blog.csdn.net/XuM222222/article/details/82022345)

[4] [天干地支-百度百科](https://baike.baidu.com/item/%E5%A4%A9%E5%B9%B2%E5%9C%B0%E6%94%AF)

[5] [闰年-百度百科](https://baike.baidu.com/item/%E9%97%B0%E5%B9%B4/27098)