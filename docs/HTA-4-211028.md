# 自定义滚动条

## 目标
看到许多网站，都有自己的自定义滚动条，所有想要学习和了解其中的秘密

## 思路
**为什么要使用自定义滚动条？**

大多数都是浏览器自带的滚动条会影响到页面布局，或者在特定页面影响页面美观度，所以要使用一个不影响页面布局和可自定义样式的滚动条。

所以自定义滚动条只要实现**不影响页面布局和可自定义样式**并且还**保留滚动条自身的功能**即可。


### <span id='foreword'>前言</span>

在没有研究透如何实现自定义滚动条并且业务上又需要解决滚动条问题时，曾经在stack overflow上看到可以通过**CSS样式**隐藏自身滚动条，并且保留滚动条效果。

```html
<div class="outer">
  <div class="inner">
    <div class="content"></div>
  </div>
</div>
```
``` css
.outer {
  width: 500px;
  height: 500px;
  position: relative;
  overflow: hidden;
  margin: 0 auto;
}
.inner {
  position: absolute;
  left: 0;
  overflow-x: hidden;
  overflow-y: scroll;
}
.content {
  width: 500px;
  height: 484px; /* 要比 .outer 的height少一点*/
  margin: 0;
  padding: 0;
}
```

<!-- 这种解决方法最明显的缺点就是用户看不出来此处是可以滚动的，必须鼠标悬停上面滚动齿轮才可以滚动，对于新用户是非常不友好的。

不过优点也就是解决了滚动条影响布局问题并且还保留滚动条自身功能。 -->

由上面解决方法得知

- 优点：解决了滚动条影响布局问题并且还保留滚动条自身功能
- 缺点：鼠标悬停在滚动区域并不会显示滚动条，无法拖拽滚动、只能鼠标滚动齿轮才可以滚动

所以只要解决**鼠标悬停时显示滚动条**与**可以拖拽滚动条**两点问题即可。


### 页面布局和自定义样式

#### 1、隐藏默认滚动条

通过[前言](#foreword)我们已经得知可以用CSS隐藏滚动条了

这里我们介绍另一个方法，也是Element UI 组件使用的方法，在Element中使用的方法与[前言](#foreword)中使用的方法有异曲同工之处

都是
**外部div - overflow:hidden**&nbsp;&nbsp; 
**内部div - overflow:scroll**
将滚动条隐藏视线之外。

```html
<div class='scrollbar'>
  <div class='scrollbar__wrap'>
    <div class="reszie">
      <div> <!-- 这里是内容 --> </div>
    </div>
  </div>
</div>
```
```css
.scrollbar {
  width: 500px;
  height: 500px;
  overflow: hidden;
  position: relative;
}
.scrollbar__wrap {
  height: 100%;
  overflow: scroll;
  margin-right: -17px;
  padding-bottom: 17px;
}
```

**17px**是通过**内部div宽度 - 外部div宽度 = 滚动条宽度**

```javascript
const scrollWidth = inner.offsetWidth - outer.offsetWidth // 17
```
> 1、这里需要注意的是必须要让**外部div有滚动条**才可以计算出正确宽度<br>
> 2、offsetWidth: 元素的边框、内边距和元素的水平滚动条


<!-- 为什么要设置**padding-bottom: 17px**，是因为height已经设置100%了，只能用padding，将滚动条挤出外部div高度 -->

<!-- 为什么不设置**padding-right: 17px**，是因为设置padding-right后，必须要设置width:100%，才可以在边缘处将滚动条挤出，然而这时内部数据都会有padding-right: 17px的边距，导致内部数据不会与边框对齐 -->


#### 2、设置滚动条样式

分别定义X轴和Y轴滚动条，将其定位并放置在**外部div的右上角和左下角**，来充当浏览器滚动条功能

```html
<div class='scrollbar'>
  <div ref='wrap' class='scrollbar__wrap'>
    <div class="reszie">
      <div> <!-- 这里是内容 --> </div>
    </div>
  </div>

  <!-- y轴滚动条 -->
  <div ref='bary' class='scrollbar__axis-y'>
    <div data-type='y' class='axis-hover'></div>
  </div>

  <!-- x轴滚动条 -->
  <div ref='barx' class='scrollbar__axis-x'>
    <div data-type='x' class='axis-hover'></div>
  </div>
</div>
```
```css
.scrollbar__wrap-y, .scrollbar__wrap-x {
  overflow: scroll;
}

.scrollbar__axis-y {
  /* 滚动条 y轴背景样式 */
  position: absolute;
  right: 0px;
  top: 2px;
  height: 100%;
  width: 8px;
  div {
    /* 滚动条 y轴样式 */
    width: 100%;
    border-radius: 10px;
    transition: 0.3s background;
    background: transparent;
    position: absolute;
  }
}

.scrollbar__axis-x {
  /* 滚动条 x轴背景样式 */
  position: absolute;
  width: 100%;
  left: 0px;
  bottom: 0px;
  height: 8px;
  div {
    /* 滚动条 x轴样式 */
    height: 100%;
    border-radius: 10px;
    transition: 0.3s background;
    background: transparent;
    position: absolute;
  }
}
```

到这里就可以自定义滚动条样式了，可以根据实际的业务需求来修改滚动条样式。

### 实现滚动条功能

#### <span id='size'>1、计算滚动条宽高</span>
滚动条的宽高，要与原生滚动条的宽高尽量保持一致，否则会出现滚动过多或者过少

```javascript
/**
* 获取滚动条宽高
* @param {object} document .scrollbar__wrap节点
*/
function getScrollSize(document) {
  const { clientHeight, scrollHeight, clientWidth, scrollWidth } = document

  // 滚动条高度 = 盒子高度 / 盒子滚动区域高度 * 换算为百分比
  const height = clientHeight / scrollHeight * 100
  const width  = clientWidth  / scrollWidth  * 100

  return { height, width }
}
```
> 1、Y轴计算高度 &nbsp;&nbsp;X轴计算宽度

#### <span id='scroll'>2、计算鼠标滚轮滚动距离</span>
监听盒子**scroll事件**，计算出鼠标滚轮滚动距离，从而同步渲染**滚动条**滚动距离

```javascript
/**
* 获取鼠标滚轮滚动距离
* @param {object} event scroll事件
*/
function getScrollDistance(event) {
  const { scrollTop, clientHeight, scrollLeft, clientWidth } = event

  // 滚动条滚动高度 = 盒子内容滚动高度 / 盒子滚动区域高度 * 换算为百分比
  const scrollY = scrollTop  / clientHeight * 100
  const scrollX = scrollLeft / clientWidth  * 100

  return { scrollY, scrollX } 
}
```

> 1、在`.scrollbar__wrap节点`添加`@scroll事件`<br>
> 2、Y轴计算高度距离 &nbsp;&nbsp;X轴计算宽度距离<br>

#### <span id='mouse'>3、计算鼠标拖动滚动条距离</span>
监听**mousedown、mousemove、mouseup**事件计算出拖动距离，从而渲染**滚动条和盒子内容**滚动距离。

```javascript

let scrollY = 0   // 鼠标点击时在滚动条中的高度，(位置错误时会出现鼠标与滚动条不同步)
let scrollBcY = 0 // 鼠标点击时在滚动条背景中的高度

// .axis-hover节点的 mousedown事件
function onCallbackMousedown(event) {
  // 防止右键点击
  if (event.ctrlKey || event.button === 2) return

  // 鼠标点击位置距离页面顶部高度 - 滚动条距离页面顶部高度
  scrollY = event.clientY - event.currentTarget.getBoundingClientRect().top

  document.addEventListener('mousemove', onCallbackMousemove, false)
  document.addEventListener('mouseup', onCallbacMouseup, false)
  document.onselectstart = () => false // 防止选中
}


// document节点的 mousemove事件
function onCallbackMousemove(event) {

  const wrap = this.$refs.wrap // .scrollbar__wrap 节点
  const bary = this.$refs.bary // .scrollbar__axis-y 节点
  
  // 鼠标拖动时距离页面顶部高度 - 滚动条背景距离页面顶部高度
  scrollBcY = event.clientY - bary.getBoundingClientRect().top
  
  // 滚动条滚动高度 = ((拖动时高度 - 点击时高度) / 滚动条高度) * 换算百分比
  const distanceBary = ((scrollBcY - scrollY) / bary.offsetHeight) * 100

  // 盒子内容滚动高度 = 滚动条滚动高度 * 盒子滚动区域高度 / 换算成数值
  const distanceBox = distanceBary * wrap.scrollHeight / 100

  this.setScroll(distanceBox) // 页面滚动动画
}


// document节点的 mouseup事件
function onCallbacMouseup(evnet) {
  document.removeEventListener('mousemove', onCallbackMousemove, false)
  document.onselectstart = null
  // 页面卸载时、在移除 mouseup监听事件
}
```

> 1、在`.axis-hover节点`添加`@mousedown事件`，之后在`mousedown事件回调函数`中再次监听`document节点的mousemove与mouseup事件`<br>


#### 4、点击滚动条背景时滚动到对应位置

点击滚动条背景时、默认定位到滚动条中间位置，之后执行[计算鼠标拖动滚动条距离](#mouse)中的**onCallbackMousemove方法**即可

由于是点击滚动条背景，并没有滚动条**点击时高度**， 所以默认就取**滚动条的一半的高度**

```javascript
function clickScrollbarBC(event) {

  // 鼠标点击时在滚动条中的高度 = 滚动条高度的中间位置
  scrollY = this.$refs.bary.offsetHeight / 2

  this.onCallbackMousemove(event)
}
```


> 1 在`.scrollbar__axis-y节点`添加`@mousedown事件`

#### 5、其他补充

[计算鼠标滚轮滚动距离](#scroll) 
- 监听鼠标滚轮滚动，计算滚动条
- 已知盒子内容滚动高度，求滚动条滚动高度
- 得出结果 赋值给滚动条 translateY或translateX

[计算鼠标拖动滚动条距离](#mouse) 
- 鼠标长按滚动条后拖动滚动条，计算出拖动的距离
- 根据拖动距离求出滚动条滚动高度，在求出盒子内容滚动高度
- 得出结果 [赋值给内容盒子 scrollTop或scrollLeft](#speed)

都是为了计算滚动距离，只是监听的方式不同、对象不同。


#### <span id='speed'>6、滚动效果</span>
在求出滚动盒子内容滚动高度后、直接赋值给**scrollTop**会被一带而过，并没有页面滚动效果，所以我们要加个页面滚动动画

```javascript
function setScroll(value) {
  const wrap = this.$refs.wrap // .scrollbar__wrap 节点
  const length = 10 // 动画分为10步
  const speed  = Math.ceil((value - wrap.scrollTop) / allSpe) // 每步的长度
  
  let index = 0

  const setAnTime = window.requestAnimationFrame || (fn => setTimeout(fn, 10))
  const setScroll = () => {
    wrap.scrollTop += speed

    if (index < length) setAnTime(setScroll)
    index += 1
  }
  setAnTime(setScroll)
}
```
## 最后

本文中示例都是以 Y轴为例，使用时把X轴也添上即可

> Y轴：top, height, translateY, scrollTop, bary<br>
> X轴：left, width, translateX, scrollLeft, barx

注意！页面改变大小时，要重新[计算滚动条宽高](#size)
## 参考文献

[1] [Element的scrollbar](https://github.com/ElemeFE/element/tree/dev/packages/scrollbar) Element的scrollbar组件源码, 非常强🤙🤙🤙